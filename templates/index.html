{% extends "base.html" %}
{% block content %}
{% if (show_carousel and all_providers|length > 0) or (not show_carousel and profile) %}
<section class="profile-hero">
  {% if show_carousel and all_providers|length > 1 %}
    <!-- Provider Carousel -->
    <div class="provider-carousel">
      <div class="carousel-container">
        <button class="carousel-btn prev" id="prevBtn">‹</button>
        <div class="carousel-track-container">
          <div class="carousel-track" id="carouselTrack">
            {% for provider in all_providers %}
            <div class="carousel-slide">
              <a href="{{ url_for('public_provider_profile', provider_id=provider.id) }}" style="text-decoration: none; color: inherit;">
                <div class="profile-card">
                  <div style="background: linear-gradient(135deg, #5aa9e6 0%, #7bb9ef 100%); height: 120px; border-radius: 12px 12px 0 0; position: relative;">
                    <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: #5aa9e6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: #1a1f2e; border: 5px solid #1a1f2e; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                      {% if provider.profile_photo and provider.profile_photo.strip() %}
                        <img src="{{ provider.profile_photo }}" alt="{{ provider.first_name or provider.business_name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
                      {% else %}
                        {{ (provider.first_name or provider.business_name or 'P')[0]|upper }}
                      {% endif %}
                    </div>
                  </div>
                  
                  <div style="padding: 70px 24px 24px; text-align: center;">
                    <h2 style="font-size: 32px; font-weight: 700; margin: 0 0 8px; color: #ffffff;">
                      {{ provider.first_name or provider.business_name or "Service Provider" }}
                    </h2>
                    <p style="font-size: 16px; color: #a3b1c6; margin: 0 0 28px;">
                      {% if provider.base_zip %}
                        Serving {{ provider.base_zip }} Area
                      {% else %}
                        Local Service Provider
                      {% endif %}
                    </p>
                    
                    <div style="display: flex; gap: 12px; margin-bottom: 16px;">
                      <button onclick="event.stopPropagation(); event.preventDefault(); window.location.href='{{ url_for('public_provider_profile', provider_id=provider.id) }}#services';" style="flex: 1; padding: 14px; background: #5aa9e6; border: none; border-radius: 24px; color: #1a1f2e; font-size: 16px; font-weight: 600; cursor: pointer;">Services</button>
                      <button onclick="event.stopPropagation(); event.preventDefault(); window.location.href='{{ url_for('public_provider_profile', provider_id=provider.id) }}#products';" style="flex: 1; padding: 14px; background: transparent; border: 2px solid #5aa9e6; border-radius: 24px; color: #5aa9e6; font-size: 16px; font-weight: 600; cursor: pointer;">Products</button>
                    </div>
                    
                    <button onclick="event.stopPropagation(); event.preventDefault(); window.location.href='{{ url_for('contact') }}';" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #5aa9e6; border-radius: 24px; color: #5aa9e6; font-size: 16px; font-weight: 600; cursor: pointer;">Contact</button>
                  </div>
                </div>
              </a>
            </div>
            {% endfor %}
          </div>
        </div>
        <button class="carousel-btn next" id="nextBtn">›</button>
      </div>
      <div class="carousel-indicators">
        {% for provider in all_providers %}
        <button class="indicator {% if loop.first %}active{% endif %}" data-slide="{{ loop.index0 }}"></button>
        {% endfor %}
      </div>
    </div>
  {% else %}
    <!-- Single Provider Card -->
    <a href="{% if featured_provider_id > 0 %}{{ url_for('public_provider_profile', provider_id=featured_provider_id) }}{% else %}#{% endif %}" style="text-decoration: none; color: inherit; display: flex; justify-content: center;">
      <div class="profile-card">
        <div style="background: linear-gradient(135deg, #5aa9e6 0%, #7bb9ef 100%); height: 120px; border-radius: 12px 12px 0 0; position: relative;">
          <div style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); width: 100px; height: 100px; background: #5aa9e6; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 48px; font-weight: bold; color: #1a1f2e; border: 5px solid #1a1f2e; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
            {% if profile.profile_photo and profile.profile_photo.strip() %}
              <img src="{{ profile.profile_photo }}" alt="{{ profile.first_name or profile.business_name }}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            {% else %}
              {{ (profile.first_name or profile.business_name or 'P')[0]|upper }}
            {% endif %}
          </div>
        </div>
        
        <div style="padding: 70px 24px 24px; text-align: center;">
          <h2 style="font-size: 32px; font-weight: 700; margin: 0 0 8px; color: #ffffff;">
            {{ profile.first_name or profile.business_name or "Service Provider" }}
          </h2>
          <p style="font-size: 16px; color: #a3b1c6; margin: 0 0 28px;">
            {% if profile.base_zip %}
              Serving {{ profile.base_zip }} Area
            {% else %}
              Local Service Provider
            {% endif %}
          </p>
          
          <div style="display: flex; gap: 12px; margin-bottom: 16px;">
            <button onclick="event.stopPropagation(); event.preventDefault(); {% if featured_provider_id > 0 %}window.location.href='{{ url_for('public_provider_profile', provider_id=featured_provider_id) }}#services';{% endif %}" style="flex: 1; padding: 14px; background: #5aa9e6; border: none; border-radius: 24px; color: #1a1f2e; font-size: 16px; font-weight: 600; cursor: pointer;">Services</button>
            <button onclick="event.stopPropagation(); event.preventDefault(); {% if featured_provider_id > 0 %}window.location.href='{{ url_for('public_provider_profile', provider_id=featured_provider_id) }}#products';{% endif %}" style="flex: 1; padding: 14px; background: transparent; border: 2px solid #5aa9e6; border-radius: 24px; color: #5aa9e6; font-size: 16px; font-weight: 600; cursor: pointer;">Products</button>
          </div>
          
          <button onclick="event.stopPropagation(); event.preventDefault(); window.location.href='{{ url_for('contact') }}';" style="width: 100%; padding: 14px; background: transparent; border: 2px solid #5aa9e6; border-radius: 24px; color: #5aa9e6; font-size: 16px; font-weight: 600; cursor: pointer;">Contact</button>
        </div>
      </div>
    </a>
  {% endif %}
</section>
{% else %}
<section class="profile-hero">
  <div style="text-align: center; padding: 60px 20px; color: var(--muted);">
    <h2>No Service Providers Available</h2>
    <p>Check back soon for service providers in your area!</p>
  </div>
</section>
{% endif %}

{% if (services and services|length > 0) or show_carousel %}
<section class="featured-section" id="featuredSection">
  <h2 id="featuredTitle">Featured Services</h2>
  <div class="cards" id="featuredContent">
    {% if not show_carousel %}
      {% for s in services %}
        {% set poster = s['posted_by'] or profile.first_name %}
        <a href="{{ url_for('contact') }}?service={{ s['title']|urlencode }}{% if poster %}&poster={{ poster|urlencode }}{% endif %}" class="card-link">
          <div class="card clickable">
            <h3>
              {{ s['title'] }}
              {% if poster %}<span class="muted" style="font-weight:normal;">by {{ poster }}</span>{% endif %}
            </h3>
            <p>{{ s['description'] or '' }}</p>
            {% if s['price'] %}<p class="price">{{ s['price'] }}</p>{% endif %}
          </div>
        </a>
      {% endfor %}
    {% else %}
      {% if all_providers and all_providers|length > 0 and all_provider_services.get(all_providers[0].id) %}
        {% for s in all_provider_services[all_providers[0].id] %}
          {% set poster = s['posted_by'] or all_providers[0].first_name %}
          <a href="{{ url_for('contact') }}?service={{ s['title']|urlencode }}{% if poster %}&poster={{ poster|urlencode }}{% endif %}" class="card-link">
            <div class="card clickable">
              <h3>
                {{ s['title'] }}
                {% if poster %}<span class="muted" style="font-weight:normal;">by {{ poster }}</span>{% endif %}
              </h3>
              <p>{{ s['description'] or '' }}</p>
              {% if s['price'] %}<p class="price">{{ s['price'] }}</p>{% endif %}
            </div>
          </a>
        {% endfor %}
      {% else %}
        <p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">No services available yet. Check back soon!</p>
      {% endif %}
    {% endif %}
  </div>
</section>
{% endif %}

<!-- Hidden data for JavaScript -->
{% if show_carousel and all_provider_services %}
<script type="application/json" id="providerServicesData">
{{ all_provider_services|tojson }}
</script>
<script type="application/json" id="providerProductsData">
{{ all_provider_products|tojson }}
</script>
<script type="application/json" id="providerNamesData">
{{ all_providers|tojson }}
</script>
{% elif not show_carousel and profile %}
<script type="application/json" id="singleProviderServices">
{{ services|tojson }}
</script>
<script type="application/json" id="singleProviderProducts">
{{ products|tojson }}
</script>
<script type="application/json" id="singleProviderData">
{{ profile|tojson }}
</script>
{% endif %}

<script>
// Provider Carousel functionality
document.addEventListener('DOMContentLoaded', function() {
  // Get carousel elements
  const track = document.getElementById('carouselTrack');
  const nextBtn = document.getElementById('nextBtn');
  const prevBtn = document.getElementById('prevBtn');
  const indicators = document.querySelectorAll('.indicator');
  const featuredContent = document.getElementById('featuredContent');
  const featuredSection = document.getElementById('featuredSection');
  const featuredTitle = document.getElementById('featuredTitle');
  
  // Handle single provider view (when provider is logged in)
  if (!track) {
    handleSingleProviderTabs();
    return;
  }
  
  let currentSlide = 0;
  let currentTab = 'services'; // Track current tab (services or products)
  const slides = track.children;
  const totalSlides = slides.length;
  let autoPlayInterval;
  let isAutoPlaying = true;
  
  // Load provider services and products data
  let providerServices = {};
  let providerProducts = {};
  let providerNames = [];
  try {
    const servicesData = document.getElementById('providerServicesData');
    const productsData = document.getElementById('providerProductsData');
    const namesData = document.getElementById('providerNamesData');
    if (servicesData) {
      providerServices = JSON.parse(servicesData.textContent);
      console.log('✅ Loaded provider services:', providerServices);
    }
    if (productsData) {
      providerProducts = JSON.parse(productsData.textContent);
      console.log('✅ Loaded provider products:', providerProducts);
    }
    if (namesData) {
      providerNames = JSON.parse(namesData.textContent);
      console.log('✅ Loaded provider names:', providerNames);
    }
  } catch (e) {
    console.error('❌ Error loading provider data:', e);
  }
  
  function updateFeaturedContent() {
    console.log('🔄 updateFeaturedContent called');
    console.log('  Current slide:', currentSlide);
    console.log('  Current tab:', currentTab);
    
    if (!featuredSection || !featuredTitle || !featuredContent) {
      console.error('❌ Missing required elements:', { featuredSection, featuredTitle, featuredContent });
      return;
    }
    
    if (!providerNames[currentSlide]) {
      console.error('❌ No provider at slide', currentSlide);
      return;
    }
    
    console.log('  Provider names array:', providerNames);
    
    const currentProvider = providerNames[currentSlide];
    console.log('  Current provider:', currentProvider);
    console.log('  Current provider ID:', currentProvider.id);
    
    const currentServices = providerServices[currentProvider.id] || [];
    const currentProducts = providerProducts[currentProvider.id] || [];
    console.log('  Services for provider', currentProvider.id, ':', currentServices);
    console.log('  Products for provider', currentProvider.id, ':', currentProducts);
    
    // Update title and content based on current tab
    const providerName = currentProvider.first_name || currentProvider.business_name;
    
    if (currentTab === 'services') {
      featuredTitle.textContent = currentServices.length > 0 ? `Featured Services by ${providerName}` : `${providerName}'s Services`;
      
      // Clear current content
      featuredContent.innerHTML = '';
      
      if (currentServices.length === 0) {
        featuredContent.innerHTML = '<p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">No services available yet. Check back soon!</p>';
      } else {
        // Add services
        currentServices.forEach(service => {
          const poster = service.posted_by || currentProvider.first_name;
          const serviceCard = document.createElement('a');
          serviceCard.href = `/contact?service=${encodeURIComponent(service.title)}${poster ? '&poster=' + encodeURIComponent(poster) : ''}`;
          serviceCard.className = 'card-link';
          
          serviceCard.innerHTML = `
            <div class="card clickable">
              <h3>
                ${service.title}
                ${poster ? '<span class="muted" style="font-weight:normal;">by ' + poster + '</span>' : ''}
              </h3>
              <p>${service.description || ''}</p>
              ${service.price ? '<p class="price">' + service.price + '</p>' : ''}
            </div>
          `;
          
          featuredContent.appendChild(serviceCard);
        });
      }
    } else {
      // Products tab
      featuredTitle.textContent = `Featured Products by ${providerName}`;
      
      // Clear current content
      featuredContent.innerHTML = '';
      
      if (currentProducts.length === 0) {
        featuredContent.innerHTML = '<p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">No products available yet. Check back soon!</p>';
      } else {
        // Add products
        currentProducts.forEach(product => {
          const productCard = document.createElement('a');
          productCard.href = `/contact?product=${encodeURIComponent(product.title)}&poster=${encodeURIComponent(providerName)}`;
          productCard.className = 'card-link';
          
          productCard.innerHTML = `
            <div class="card clickable">
              <h3>${product.title}</h3>
              <p>${product.description || ''}</p>
              ${product.price ? '<p class="price">' + product.price + '</p>' : ''}
            </div>
          `;
          
          featuredContent.appendChild(productCard);
        });
      }
    }
    
    featuredSection.style.display = 'block';
  }
  
  function updateCarousel() {
    const translateX = -currentSlide * 100;
    track.style.transform = `translateX(${translateX}%)`;
    
    // Update indicators
    indicators.forEach((indicator, index) => {
      indicator.classList.toggle('active', index === currentSlide);
    });
    
    // Sync tab states across all provider cards
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.classList.remove('active');
    });
    document.querySelectorAll(`[data-tab="${currentTab}"]`).forEach(btn => {
      btn.classList.add('active');
    });
    
    // Update featured content
    updateFeaturedContent();
  }
  
  function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    updateCarousel();
  }
  
  function prevSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    updateCarousel();
  }
  
  function startAutoPlay() {
    if (isAutoPlaying) {
      autoPlayInterval = setInterval(nextSlide, 12000);
    }
  }
  
  function stopAutoPlay() {
    if (autoPlayInterval) {
      clearInterval(autoPlayInterval);
    }
  }
  
  function pauseCarousel() {
    isAutoPlaying = false;
    stopAutoPlay();
  }
  
  // Event listeners
  if (nextBtn) {
    nextBtn.addEventListener('click', () => {
      pauseCarousel();
      nextSlide();
    });
  }
  
  if (prevBtn) {
    prevBtn.addEventListener('click', () => {
      pauseCarousel();
      prevSlide();
    });
  }
  
  indicators.forEach((indicator, index) => {
    indicator.addEventListener('click', () => {
      pauseCarousel();
      currentSlide = index;
      updateCarousel();
    });
  });
  
  // Initialize carousel if we have the required elements
  if (track && indicators.length > 0) {
    // Force show the featured section with test content first
    if (featuredSection && featuredContent) {
      featuredSection.style.display = 'block';
      featuredContent.innerHTML = '<div style="color: white; padding: 20px;">Loading services...</div>';

    }
    
    updateCarousel(); // This will call updateFeaturedContent() with proper carousel state
    
    // Start auto-play initially
    startAutoPlay();
  }
  
  // Touch/swipe support for mobile
  if (track) {
    let startX = 0;
    let isDragging = false;
    
    track.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      isDragging = true;
    });
    
    track.addEventListener('touchmove', (e) => {
      if (!isDragging) return;
      e.preventDefault();
    });
    
    track.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      isDragging = false;
      
      const endX = e.changedTouches[0].clientX;
      const diffX = startX - endX;
      
      if (Math.abs(diffX) > 50) { // Minimum swipe distance
        if (diffX > 0) {
          nextSlide();
        } else {
          prevSlide();
        }
      }
    });
  }
  
  // Setup tab buttons with a helper function
  function setupTabButtons() {
    const tabButtons = document.querySelectorAll('.tab-btn');

    
    tabButtons.forEach((btn, index) => {

      btn.addEventListener('click', function(e) {


        e.preventDefault();
        e.stopPropagation();
        
        pauseCarousel();
        currentTab = this.dataset.tab;

        
        // Update all tab buttons
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.remove('active');
        });
        
        // Find all buttons with the same tab type and activate them
        document.querySelectorAll(`[data-tab="${currentTab}"]`).forEach(b => {
          b.classList.add('active');
        });
        

        updateFeaturedContent();
      });
    });
  }
  
  // Setup tab buttons after DOM load
  setTimeout(setupTabButtons, 100);
});

// Card flip functionality removed - cards now link directly to profile page

// Handle single provider tab switching
function handleSingleProviderTabs() {

  
  let singleProviderServices = [];
  let singleProviderProducts = [];
  let singleProviderData = {};
  
  try {
    const servicesData = document.getElementById('singleProviderServices');
    const productsData = document.getElementById('singleProviderProducts');
    const providerData = document.getElementById('singleProviderData');
    
    if (servicesData) singleProviderServices = JSON.parse(servicesData.textContent);
    if (productsData) singleProviderProducts = JSON.parse(productsData.textContent);
    if (providerData) singleProviderData = JSON.parse(providerData.textContent);
    

  } catch (e) {
    return;
  }
  
  const featuredSection = document.getElementById('featuredSection');
  const featuredTitle = document.getElementById('featuredTitle');
  const featuredContent = document.getElementById('featuredContent');
  
  if (!featuredSection || !featuredTitle || !featuredContent) {
    console.error('Missing required elements for single provider tabs');
    return;
  }
  
  let currentTab = 'services';
  
  function updateSingleProviderContent() {

    
    const providerName = singleProviderData.first_name || singleProviderData.business_name || 'Provider';
    
    if (currentTab === 'services') {
      featuredTitle.textContent = `Featured Services`;
      featuredContent.innerHTML = '';
      
      if (singleProviderServices.length === 0) {
        featuredContent.innerHTML = '<p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">No services available yet.</p>';
      } else {
        singleProviderServices.forEach(service => {
          const poster = service.posted_by || providerName;
          const serviceCard = document.createElement('a');
          serviceCard.href = `/contact?service=${encodeURIComponent(service.title)}${poster ? '&poster=' + encodeURIComponent(poster) : ''}`;
          serviceCard.className = 'card-link';
          
          serviceCard.innerHTML = `
            <div class="card clickable">
              <h3>
                ${service.title}
                ${poster ? '<span class="muted" style="font-weight:normal;">by ' + poster + '</span>' : ''}
              </h3>
              <p>${service.description || ''}</p>
              ${service.price ? '<p class="price">' + service.price + '</p>' : ''}
            </div>
          `;
          
          featuredContent.appendChild(serviceCard);
        });
      }
    } else {
      featuredTitle.textContent = `Featured Products`;
      featuredContent.innerHTML = '';
      
      if (singleProviderProducts.length === 0) {
        featuredContent.innerHTML = '<p style="color: var(--muted); text-align: center; grid-column: 1 / -1;">No products available yet.</p>';
      } else {
        singleProviderProducts.forEach(product => {
          const productCard = document.createElement('a');
          productCard.href = `/contact?product=${encodeURIComponent(product.title)}&poster=${encodeURIComponent(providerName)}`;
          productCard.className = 'card-link';
          
          productCard.innerHTML = `
            <div class="card clickable">
              <h3>${product.title}</h3>
              <p>${product.description || ''}</p>
              ${product.price ? '<p class="price">' + product.price + '</p>' : ''}
            </div>
          `;
          
          featuredContent.appendChild(productCard);
        });
      }
    }
    
    featuredSection.style.display = 'block';
  }
  
  // Add tab button listeners
  setTimeout(() => {
    const tabButtons = document.querySelectorAll('.tab-btn');

    
    tabButtons.forEach(btn => {
      btn.addEventListener('click', function(e) {

        e.preventDefault();
        e.stopPropagation();
        
        currentTab = this.dataset.tab;
        
        // Update tab button states
        tabButtons.forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        updateSingleProviderContent();
      });
    });
    
    // Initialize with services
    updateSingleProviderContent();
  }, 100);
}
</script>
{% endblock %}
