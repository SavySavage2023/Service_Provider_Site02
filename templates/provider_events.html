{% extends "base.html" %}
{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
  <h1 style="margin: 0;">Provider Schedule</h1>
  <div style="display: flex; gap: 12px;">
    <a href="{{ url_for('provider_dashboard') }}" class="btn-secondary">‚Üê Back to Dashboard</a>
  </div>
</div>

<!-- Calendar View -->
<div id="calendar" style="background: var(--panel); border: 1px solid #232a36; border-radius: 12px; padding: 20px; margin-bottom: 30px;">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
    <button id="prevMonth" class="btn-secondary" style="padding: 8px 16px;">‚Üê Previous</button>
    <div style="display: flex; gap: 12px; align-items: center;">
      <select id="monthSelect" style="padding: 8px 12px; background: var(--bg); color: var(--text); border: 1px solid #232a36; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
        <option value="0">January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
      <select id="yearSelect" style="padding: 8px 12px; background: var(--bg); color: var(--text); border: 1px solid #232a36; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">
        <!-- Years will be populated by JavaScript -->
      </select>
    </div>
    <button id="nextMonth" class="btn-secondary" style="padding: 8px 16px;">Next ‚Üí</button>
  </div>
  
  <div id="calendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px;">
    <!-- Calendar days will be inserted here by JavaScript -->
  </div>
  
  <!-- Stats Cards -->
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-top: 20px;">
    <a href="{{ url_for('provider_leads', filter='completed') }}" title="View Completed Leads" style="display: block; text-decoration: none; color: inherit;">
      <div style="background: var(--bg); border: 1px solid #232a36; border-radius: 8px; padding: 12px; text-align: center;">
        <div style="font-size: 24px; font-weight: 700; color: var(--text);">{{ completed }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Completed</div>
      </div>
    </a>
    <a href="{{ url_for('provider_leads', filter='rejected') }}" title="View Rejected Leads" style="display: block; text-decoration: none; color: inherit;">
      <div style="background: var(--bg); border: 1px solid #232a36; border-radius: 8px; padding: 12px; text-align: center;">
        <div style="font-size: 24px; font-weight: 700; color: var(--text);">{{ rejected }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Rejected</div>
      </div>
    </a>
    <a href="{{ url_for('provider_leads', filter='subscribers') }}" title="View Weekly Subscribers" style="display: block; text-decoration: none; color: inherit;">
      <div style="background: var(--bg); border: 1px solid #232a36; border-radius: 8px; padding: 12px; text-align: center;">
        <div style="font-size: 24px; font-weight: 700; color: var(--text);">{{ subscribers }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Subscribers</div>
      </div>
    </a>
    <a href="{{ url_for('provider_blocked_addresses') }}" title="View Blocked Addresses" style="display: block; text-decoration: none; color: inherit;">
      <div style="background: var(--bg); border: 1px solid #232a36; border-radius: 8px; padding: 12px; text-align: center;">
        <div style="font-size: 24px; font-weight: 700; color: var(--text);">{{ blocked }}</div>
        <div style="font-size: 12px; color: var(--muted); margin-top: 4px;">Blocked</div>
      </div>
    </a>
  </div>
  
  <div id="dayValueBar" style="margin-top: 16px; padding: 12px; background: var(--panel); border: 1px solid #232a36; color: var(--text); border-radius: 8px; font-weight: 600; text-align: right;">
    Value to Hour: $0.00/0
  </div>
</div>

<!-- Events List -->
<div class="events-list">
  <div style="display: flex; justify-content: flex-start; align-items: center; gap: 16px; margin-bottom: 16px;">
    <h2 style="margin: 0;">All Events</h2>
    <a href="{{ url_for('provider_event_new') }}" class="btn-primary" style="padding: 6px 12px; font-size: 14px;">+ Add/Edit</a>
  </div>
  {% if events %}
    <div style="display: grid; gap: 16px;">
      {% for event in events %}
        <div class="card" style="padding: 20px; {% if event.blocked %}opacity: 0.5;{% endif %}">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
            <div style="flex: 1;">
              <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                <h3 style="margin: 0; color: var(--text);">{{ event.title }}</h3>
                {% if event.status == 'completed' %}
                  <span style="padding: 2px 8px; background: #2ecc71; color: #000; border-radius: 4px; font-size: 12px; font-weight: 600;">Completed</span>
                {% elif event.status == 'rejected' %}
                  <span style="padding: 2px 8px; background: #e74c3c; color: #fff; border-radius: 4px; font-size: 12px; font-weight: 600;">Rejected</span>
                {% else %}
                  <span style="padding: 2px 8px; background: var(--accent); color: #000; border-radius: 4px; font-size: 12px; font-weight: 600;">Pending</span>
                {% endif %}
                {% if event.blocked %}
                  <span style="padding: 2px 8px; background: #95a5a6; color: #fff; border-radius: 4px; font-size: 12px; font-weight: 600;">Blocked</span>
                {% endif %}
              </div>
              <p style="color: var(--muted); margin: 0 0 8px 0;">
                <strong>üìÖ {{ event.date }}</strong>
                {% if event.location %} ‚Ä¢ üìç {{ event.location }}{% endif %}
                {% if event.zip %} ‚Ä¢ ZIP: {{ event.zip }}{% endif %}
              </p>
              {% if event.description %}
                <p style="color: var(--muted); margin: 0 0 12px 0;">{{ event.description }}</p>
              {% endif %}
              <div style="display: flex; gap: 16px; margin-top: 12px;">
                <div>
                  <div style="color: #2ecc71; font-size: 14px; font-weight: 600;">Price</div>
                  <div style="color: var(--text); font-size: 18px; font-weight: 700;">${{ "%.0f"|format(event.price or 0) }}</div>
                </div>
                <div>
                  <div style="color: #2ecc71; font-size: 14px; font-weight: 600;">Hours</div>
                  <div style="color: var(--text); font-size: 18px; font-weight: 700;">{{ "%.0f"|format(event.hours or 0) }}</div>
                </div>
              </div>
            </div>
            <div style="display: flex; gap: 8px; margin-left: 16px;">
              <a href="{{ url_for('provider_event_edit', event_id=event.id) }}" class="btn-secondary" style="padding: 8px 16px; text-decoration: none;">Edit</a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <p style="color: var(--muted); text-align: center; padding: 40px;">No events yet. Click "Add New Event" to create your first event.</p>
  {% endif %}
</div>

<script>
// Calendar functionality
let currentDate = new Date();
let events = {{ events|tojson|safe }};
let selectedDateStr = null; // YYYY-MM-DD currently selected in calendar

const monthNames = ["January", "February", "March", "April", "May", "June",
  "July", "August", "September", "October", "November", "December"];
const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

// Populate year dropdown
function populateYearDropdown() {
  const yearSelect = document.getElementById('yearSelect');
  const currentYear = new Date().getFullYear();
  
  for (let year = currentYear - 1; year <= currentYear + 1; year++) {
    const option = document.createElement('option');
    option.value = year;
    option.textContent = year;
    yearSelect.appendChild(option);
  }
}

// Update dropdowns to match current date
function updateDropdowns() {
  document.getElementById('monthSelect').value = currentDate.getMonth();
  document.getElementById('yearSelect').value = currentDate.getFullYear();
}

function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  
  updateDropdowns();
  
  const firstDay = new Date(year, month, 1);
  const lastDay = new Date(year, month + 1, 0);
  const daysInMonth = lastDay.getDate();
  const startingDayOfWeek = firstDay.getDay();
  
  const calendarGrid = document.getElementById('calendarGrid');
  calendarGrid.innerHTML = '';
  
  // Add day headers
  dayNames.forEach(day => {
    const dayHeader = document.createElement('div');
    dayHeader.textContent = day;
    dayHeader.style.cssText = 'text-align: center; font-weight: 600; padding: 8px; color: var(--accent);';
    calendarGrid.appendChild(dayHeader);
  });
  
  // Add empty cells for days before month starts
  for (let i = 0; i < startingDayOfWeek; i++) {
    const emptyCell = document.createElement('div');
    emptyCell.style.cssText = 'min-height: 80px; border: 1px solid #232a36; border-radius: 8px; background: var(--bg);';
    calendarGrid.appendChild(emptyCell);
  }
  
  // Add days of the month
  const today = new Date();
  const isCurrentMonth = (today.getFullYear() === year && today.getMonth() === month);
  // If selected date is not in this month, clear it so we don't show stale numbers
  if (selectedDateStr) {
    const [sy, sm] = selectedDateStr.split('-').map(Number);
    if (sy !== year || (sm - 1) !== month) selectedDateStr = null;
  }
  
  for (let day = 1; day <= daysInMonth; day++) {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    const dayEvents = events.filter(e => (e.date === dateStr || e.event_date === dateStr));
  const isToday = (isCurrentMonth && today.getDate() === day);
  const isSelected = selectedDateStr === dateStr;
    
    const dayCell = document.createElement('div');
  const bgColor = isSelected ? 'rgba(0, 122, 255, 0.10)' : (isToday ? 'rgba(255, 193, 7, 0.15)' : 'var(--panel)');
  const borderColor = isSelected ? 'rgba(0, 122, 255, 0.65)' : (isToday ? 'rgba(255, 193, 7, 0.5)' : '#232a36');
  dayCell.style.cssText = `min-height: 80px; border: 2px solid ${borderColor}; border-radius: 8px; padding: 8px; background: ${bgColor}; cursor: pointer; transition: all 0.2s;`;
    
    const dayNumber = document.createElement('div');
    dayNumber.textContent = day;
    const dayColor = isToday ? 'var(--accent)' : 'var(--text)';
    dayNumber.style.cssText = `font-weight: ${isToday ? '700' : '600'}; margin-bottom: 4px; color: ${dayColor};`;
    dayCell.appendChild(dayNumber);
    
    // Add event indicators
    dayEvents.forEach(event => {
      const eventDot = document.createElement('div');
      eventDot.textContent = event.title.substring(0, 15) + (event.title.length > 15 ? '...' : '');
      eventDot.style.cssText = 'font-size: 10px; padding: 2px 4px; margin-top: 2px; background: var(--accent); color: #000; border-radius: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;';
      dayCell.appendChild(eventDot);
    });
    
    dayCell.addEventListener('mouseenter', () => {
      dayCell.style.borderColor = 'var(--accent)';
    });
    dayCell.addEventListener('mouseleave', () => {
      const originalBorder = isSelected ? 'rgba(0, 122, 255, 0.65)' : (isToday ? 'rgba(255, 193, 7, 0.5)' : '#232a36');
      dayCell.style.borderColor = originalBorder;
    });
    dayCell.addEventListener('click', () => {
      selectedDateStr = dateStr;
      updateSelectedDayValue();
      renderCalendar();
    });
    
    calendarGrid.appendChild(dayCell);
  }

  // If nothing selected, default to today (when visible) or first day of month
  if (!selectedDateStr) {
    if (isCurrentMonth) {
      selectedDateStr = `${year}-${String(month + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
    } else {
      selectedDateStr = `${year}-${String(month + 1).padStart(2,'0')}-01`;
    }
  }
  updateSelectedDayValue();
}

function updateSelectedDayValue() {
  const bar = document.getElementById('dayValueBar');
  if (!bar || !selectedDateStr) return;
  const dayEvts = events.filter(e => (e.date === selectedDateStr || e.event_date === selectedDateStr));
  const value = dayEvts.reduce((sum, e) => sum + (e.price || 0), 0);
  const hours = dayEvts.reduce((sum, e) => sum + (e.hours || 0), 0);
  const vph = hours > 0 ? (value / hours) : 0;
  bar.textContent = `Value to Hour: $${vph.toFixed(2)}/${hours}`;
}

document.getElementById('prevMonth').addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  renderCalendar();
});

document.getElementById('nextMonth').addEventListener('click', () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  renderCalendar();
});

document.getElementById('monthSelect').addEventListener('change', (e) => {
  currentDate.setMonth(parseInt(e.target.value));
  renderCalendar();
});

document.getElementById('yearSelect').addEventListener('change', (e) => {
  currentDate.setFullYear(parseInt(e.target.value));
  renderCalendar();
});

// Initial setup
populateYearDropdown();
renderCalendar();
</script>
{% endblock %}
